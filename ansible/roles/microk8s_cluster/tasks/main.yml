- name: Ensure MicroK8s is ready
  ansible.builtin.command: microk8s status --wait-ready
  changed_when: false

- name: Enable MicroK8s addons on primary
  ansible.builtin.command: microk8s enable dns hostpath-storage ingress
  when: cluster_primary
  changed_when: false

- name: Create join command on primary
  ansible.builtin.shell: microk8s add-node --token-ttl 3600 --format short
  register: join_output
  when: cluster_primary

- name: Extract join command
  ansible.builtin.set_fact:
    join_cmd: "{{ join_output.stdout_lines | select('search', '^microk8s join') | list | first }}"
  when: cluster_primary

- name: Copy join command to worker nodes
  ansible.builtin.copy:
    content: "{{ join_cmd }}"
    dest: /tmp/join_cmd.sh
    mode: "0755"
  delegate_to: "{{ item }}"
  with_items: "{{ groups['cluster'] | difference([inventory_hostname]) }}"
  when: cluster_primary
  run_once: true

- name: Check if node already exists in cluster
  ansible.builtin.shell: microk8s kubectl get nodes -o name | grep "{{ hostvars[inventory_hostname]['kubelet_name'] }}"
  delegate_to: node1
  register: node_exists
  failed_when: false
  changed_when: false
  when: not cluster_primary

- name: Join worker when missing
  ansible.builtin.shell: bash /tmp/join_cmd.sh
  when: not cluster_primary and node_exists.rc != 0
  register: join_result
  retries: 3
  delay: 10
  until: join_result.rc == 0

- name: Wait for worker readiness after join
  ansible.builtin.command: microk8s status --wait-ready
  when: not cluster_primary and node_exists.rc != 0
  changed_when: false
